好的，作为一名资深的Next.js前端工程师，我将基于您提供的三份详尽文档（产品需求文档、UI设计文档、技术架构文档），编写一份完整的前端开发实施指南。

这份文档将作为我们团队的“单一事实来源 (Single Source of Truth)”，旨在让任何一位前端开发者都能据此独立、高质量地完成《轻盈》v1.2版本的开发工作。

---

# **《轻盈》(The Lightness App) v1.2 前端开发实施文档**

**版本：** 1.0
**负责人：** Gemini (Senior Frontend Engineer)
**更新时间：** 2025年10月26日

## 1. 项目启动与核心理念

### 1.1 项目目标
我们的任务是构建一款“过程体验设计器”。请牢记，我们的目标**不是**开发一个效率工具，而是创造一个能帮助用户**“在做的过程中感觉更好”**的数字空间。每一个技术决策、每一行动画都必须服务于这一核心情感目标。

### 1.2 架构原则
根据技术架构文档，我们遵循以下三大原则：
1.  **本地优先 (Local-First):** 用户核心数据（任务、日志）是应用的灵魂，必须存储在客户端的IndexedDB中。这保证了极致的性能、隐私和离线可用性。
2.  **客户端渲染 (CSR):** 我们将Next.js主要用作一个高性能的单页应用(SPA)启动器。在主页面布局中声明`"use client;"`，所有数据获取和渲染都在客户端完成。
3.  **触感体验 (Tactile):** 动画不是点缀，而是核心交互的一部分。我们将大量使用`Framer Motion`和`Styled Components`来实现UI文档中定义的“物理感”和“呼吸感”。

### 1.3 环境搭建
1.  **克隆仓库**
    ```bash
    git clone <repository_url>
    cd lightness-app
    ```
2.  **安装依赖**
    ```bash
    npm install
    ```
3.  **配置环境变量**
    在项目根目录创建`.env.local`文件，并添加AI服务的API密钥。此密钥仅用于本地开发时BFF的调用。
    ```
    ZHIPU_AI_API_KEY="your_api_key_here"
    ```
4.  **运行开发服务器**
    ```bash
    npm run dev
    ```
    应用将在`http://localhost:3000`上运行。

## 2. 项目结构

我们将采用基于功能和原子设计的混合结构，以保持代码的清晰和可维护性。

```
/
├── app/                  # Next.js App Router
│   ├── (main)/           # 主应用路由组
│   │   ├── design/[id]/  # 体验设计向导页
│   │   ├── log/[id]/     # 体验日志页
│   │   ├── playbook/     # 我的游玩手册页
│   │   └── page.jsx      # 主页：游乐场 (The Playground)
│   ├── api/              # BFF (Backend-for-Frontend)
│   │   └── get-suggestion/
│   │       └── route.js  # AI建议的路由处理器
│   └── layout.jsx        # 根布局
├── components/
│   ├── atoms/            # 基础原子组件 (Button, Input, Card)
│   ├── molecules/        # 由原子组成的稍复杂组件 (TaskItem, PersonaSelector)
│   ├── organisms/        # 页面级的大型组件 (PlaygroundList, WizardForm)
│   └── providers/        # 全局Provider组件 (ThemeProvider, DataSubscriber)
├── lib/
│   └── db.js             # Dexie.js 数据库定义与实例
├── store/
│   └── experienceStore.js # Zustand 全局状态管理
├── styles/
│   ├── GlobalStyles.js   # 全局CSS样式
│   └── theme.js          # Styled Components 主题对象
└── hooks/
    └── useExperiences.js # (可选) 封装数据订阅逻辑的自定义Hook
```

## 3. 全局设置 (The Foundation)

### 3.1 主题与全局样式
1.  **创建主题文件 (`/styles/theme.js`):**
    根据《品牌风格规范表》，将所有颜色、字体、圆角等视觉变量定义在此。
    ```javascript
    // /styles/theme.js
    export const theme = {
      colors: {
        background: '#FDFBF6',
        text: '#4A443F',
        primary: '#F9B572', // 蜜桃橙
        accentYellow: '#FEEA91', // 便利贴黄
        accentGreen: '#B4D9D0', // 真诚绿
        neutral: '#D9D6D2',
        white: '#FFFFFF',
      },
      fonts: {
        heading: "'Nunito', sans-serif",
        body: "'Inter', sans-serif",
        handwriting: "'Caveat', cursive",
      },
      // ... 其他设计变量
    };
    ```
2.  **创建全局样式 (`/styles/GlobalStyles.js`):**
    设置全局`background-color`, `font-family`, `color`等，并重置默认样式。
    ```javascript
    // /styles/GlobalStyles.js
    import { createGlobalStyle } from 'styled-components';

    export const GlobalStyles = createGlobalStyle`
      body {
        background-color: ${({ theme }) => theme.colors.background};
        font-family: ${({ theme }) => theme.fonts.body};
        color: ${({ theme }) => theme.colors.text};
        // ... 其他全局样式
      }
    `;
    ```
3.  **集成Styled Components:**
    在根布局`app/layout.jsx`中，使用`StyledComponentsRegistry`和`ThemeProvider`包裹子组件，注入主题和全局样式。

## 4. 数据层 (Dexie.js + Zustand)

这是应用的核心。数据流必须严格遵循技术架构文档中定义的**响应式模型**。

### 4.1 Dexie数据库设置
在`/lib/db.js`中，根据技术架构文档的Schema定义数据库。```javascript
// /lib/db.js
import Dexie from 'dexie';

export const db = new Dexie('LightnessAppDB');

db.version(1).stores({
  experiences: [
    '++id',         // 主键,自增
    'status',       // 索引: 'undesigned', 'designed', 'logged'
    'createdAt',    // 索引: 用于排序
    'design.persona', // 复合索引: 用于筛选
    'log.feeling'   // 复合索引: 用于筛选
  ].join(',')
});
```

### 4.2 Zustand状态管理
创建`/store/experienceStore.js`来存放从数据库订阅来的数据。
```javascript
// /store/experienceStore.js
import { create } from 'zustand';

export const useExperienceStore = create((set) => ({
  undesignedTasks: [],
  designedTasks: [],
  loggedTasks: [],
  setUndesignedTasks: (tasks) => set({ undesignedTasks: tasks }),
  setDesignedTasks: (tasks) => set({ designedTasks: tasks }),
  setLoggedTasks: (tasks) => set({ loggedTasks: tasks }),
}));
```

### 4.3 实现响应式数据流
在`/components/providers/DataSubscriber.jsx`中，使用`dexie-react-hooks`的`useLiveQuery`来监听数据库变化，并自动更新Zustand store。

```jsx
// /components/providers/DataSubscriber.jsx
'use client';

import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '@/lib/db';
import { useExperienceStore } from '@/store/experienceStore';
import { useEffect } from 'react';

export function DataSubscriber() {
  const { setUndesignedTasks, setDesignedTasks, setLoggedTasks } = useExperienceStore();

  const undesigned = useLiveQuery(
    () => db.experiences.where('status').equals('undesigned').sortBy('createdAt'),
    []
  );
  // ... similar queries for 'designed' and 'logged'

  useEffect(() => {
    if (undesigned) setUndesignedTasks(undesigned);
  }, [undesigned, setUndesignedTasks]);
  
  // ... similar useEffects for other states

  return null; // This component does not render anything
}
```
**重要:** 在根布局`app/layout.jsx`中引入并使用`<DataSubscriber />`，使其常驻于应用中。

## 5. 原子组件开发 (UI & 动画)

请严格按照《UI设计文档》中的**“核心组件状态系统”**章节进行开发。以下是关键组件的实现要点：

### 5.1 `<CapsuleButton />` (`/components/atoms/Button.jsx`)
-   **Props:** `children`, `onClick`, `disabled`
-   **Styling (Styled Components):**
    -   默认状态：背景色`theme.colors.primary`，带弥散阴影。
    -   `:hover`：阴影加深，`transform: translateY(-2px);`
    -   `:active` (Pressed): 阴影消失，`transform: translateY(-1px) scale(0.98);`
    -   `:focus-visible` (Focus): 出现柔和的蜜桃橙色`box-shadow`光晕。
    -   `[disabled]`: 移除阴影，降低背景色饱和度。
-   **Animation (Framer Motion):**
    ```jsx
    <motion.button
      whileHover={{ y: -2, boxShadow: "..." }}
      whileTap={{ y: -1, scale: 0.98, boxShadow: "none" }}
      transition={{ type: "spring", stiffness: 400, damping: 17 }}
    >
      {children}
    </motion.button>
    ```

### 5.2 `<InputField />` (`/components/atoms/Input.jsx`)
-   **Styling (Styled Components):**
    -   **底线动画：** 使用`::after`伪元素，在`:focus-within`时`transform: scaleX(1)`，`transform-origin: center`。
    -   **光标：** `caret-color: theme.colors.text;`，并使用`@keyframes`自定义呼吸式闪烁动画。
    -   **标签浮动：** 将`placeholder`用`<label>`元素实现，通过CSS根据输入框`:focus`或`:not(:placeholder-shown)`状态来改变其`transform`和`font-size`。

### 5.3 `<TaskCard />` (`/components/atoms/Card.jsx`)
-   **Props:** `experience`, `onClick`
-   **Styling:** 圆角`12px`，白色背景，柔和阴影。
-   **Animation:**
    -   **悬浮 (Hover):** 使用`whileHover`实现`y: -4`和`scale: 1.02`。
    -   **颜色状态:** 卡片的颜色/边框色应根据`experience.status`动态变化 (`undesigned` -> 灰色, `designed` -> 彩色, `logged` -> 橙/绿边框)。

## 6. 页面与功能实现

### 6.1 主页：游乐场 (`app/page.jsx`)
-   **布局:** 顶部是`<InputField />`，下方是两个区域：“游戏设计图”和“今日游玩”。
-   **数据:**
    -   使用`useExperienceStore`获取`undesignedTasks`和`designedTasks`数组。
    -   `.map()`渲染成`<TaskCard />`列表。
-   **逻辑:**
    -   在输入框按下回车，调用`db.experiences.add({ title: ..., status: 'undesigned', ... })`。
    -   点击灰色卡片，使用`next/navigation`的`useRouter`跳转到`router.push('/design/' + task.id)`。
-   **空状态:** 当两个列表都为空时，显示UI文档中指定的插画和引导文案。

### 6.2 体验设计向导 (`app/design/[id]/page.jsx`)
-   **布局:** 这是一个多步骤的模态窗口或页面。
-   **数据:**
    -   通过`useParams`获取`id`。
    -   使用`useLiveQuery`或一个简单的`db.experiences.get(id)`获取当前任务。
-   **逻辑:**
    1.  **神奇便利贴:** 一个受控的`<textarea />`。
    2.  **选择人格:** 实现一个水平滚动的`<PersonaSelector />`组件。
    3.  **支线任务 (AI):**
        -   当用户选择人格后，向`/api/get-suggestion`发送POST请求，body为`{ title: task.title, persona: selectedPersona }`。
        -   **关键：** 实现**非评判性错误处理**。如果fetch失败或返回`{ success: false }`，**不要显示任何错误提示**。只需让用户可以手动在输入框中填写自己的想法即可。
    4.  **保存:** 点击“完成设计”按钮，调用`db.experiences.update(id, { status: 'designed', design: { ... } })`，然后`router.back()`返回主页。

### 6.3 游玩模式 (`app/play/[id]/page.jsx` - *假设*有此页面)
-   **核心交互:** “真诚/认真”模式切换开关。
-   **实现:**
    -   这是一个`<Switch />`组件。
    -   当切换到“真诚”时，使用`styled-components`的`ThemeProvider`或CSS变量动态改变页面的`background-color`为`theme.colors.accentGreen`，并伴随一个`800ms`的`ease-in-out`过渡。

### 6.4 体验日志 (`app/log/[id]/page.jsx`)
-   **布局:** 类似日记页面的表单。
-   **逻辑:**
    -   提供Emoji或关键词选择器来记录感受。
    -   根据用户选择的体验是正向还是负向，显示不同的引导问题（“是什么让它变得有趣？” vs “这次实验告诉了你什么？”）。
    -   保存时，调用`db.experiences.update(id, { status: 'logged', log: { ... } })`。

### 6.5 我的游玩手册 (`app/playbook/page.jsx`)
-   **布局:** 卡片列表或网格。
-   **数据:**
    -   使用`useExperienceStore`获取`loggedTasks`。
    -   根据`log.feeling`是正向还是负向，给`<TaskCard />`传递一个prop，使其渲染成“成功秘笈”（橙色边框）或“数据点”（绿色边框）。
-   **功能:** 实现筛选功能。筛选逻辑直接在客户端执行，可以通过修改`useLiveQuery`的查询条件或在前端对Zustand中的数据进行`.filter()`。

## 7. BFF (AI代理)

### `/app/api/get-suggestion/route.js`
-   **目的:** 隐藏API Key，构建Prompt。
-   **实现:**
    ```javascript
    // /app/api/get-suggestion/route.js
    import { NextResponse } from 'next/server';

    export async function POST(request) {
      try {
        const { title, persona } = await request.json();
        const apiKey = process.env.ZHIPU_AI_API_KEY;

        const prompt = `你是一个“过程体验设计器”。任务是"${title}"，人格是"${persona}"。请推荐一个简短、有趣、充满好奇心的“支线任务”（Side Quest）。请直接返回支线任务，不要多余的话。`;

        // ... 此处是调用智谱AI SDK或fetch的代码 ...
        
        const aiResponse = "用与平时相反的顺序打扫房间。"; // 示例返回

        return NextResponse.json({ success: true, suggestion: aiResponse });

      } catch (error) {
        console.error('AI Suggestion API Error:', error);
        // 静默失败，不将服务端错误暴露给客户端
        return NextResponse.json({ success: false, suggestion: null });
      }
    }
    ```

---

## 8. 开发清单与最佳实践
-   [ ] **可访问性 (a11y):** 所有交互元素（按钮、输入框）必须有清晰的`:focus-visible`状态。使用语义化HTML。
-   [ ] **性能:** 严格遵守CSR模式，避免不必要的服务端逻辑。利用Next.js的代码分割。
-   [ ] **代码风格:** 配置ESLint和Prettier，并遵循团队规范。
-   [ ] **组件化:** 任何重复使用的UI都应抽象为组件。
-   [ ] **文档注释:** 对复杂的逻辑或组件props添加JSDoc注释。

本开发文档提供了从0到1构建《轻盈》应用的完整路径。请各位开发者在开发过程中，频繁回顾PRD和UI文档，确保我们的最终产品不仅功能完备，更能传递出“轻盈、真诚、非评判”的核心品牌精神。祝开发愉快！